import numpy as np
import faiss
from sentence_transformers import SentenceTransformer
from google import genai

# ---------------------------------------------------------------------------
# 1. Data Preparation
#    架空企業「エグザンプルデータパブリッシャー」の社内ナレッジベース
# ---------------------------------------------------------------------------
documents = [
    # --- 会社概要 ---
    "株式会社エグザンプルデータパブリッシャーは2015年に大阪で創業したAIスタートアップである。2022年3月に本社を横浜市みなとみらいのZetaタワー28階に移転した。代表取締役CEOは佐藤健一。",
    "エグザンプルデータパブリッシャーの従業員数は2023年度末時点で1,523名、2024年度末時点で1,847名である。エンジニア比率は全体の62%を占める。",

    # --- 財務情報 ---
    "エグザンプルデータパブリッシャーの2023年度の売上高は290億円、営業利益は32億円（営業利益率11.0%）であった。",
    "エグザンプルデータパブリッシャーの2024年度の売上高は342億円（前年比+18%）、営業利益は45億円（営業利益率13.2%）であった。主力製品ZetaCore v3の販売が好調で、海外売上比率は28%に達した。",
    "エグザンプルデータパブリッシャーの研究開発費は2023年度が38億円、2024年度が51億円で、売上高比率はそれぞれ13.1%、14.9%であった。",

    # --- 製品情報 ---
    "ZetaCore v3はエッジAI推論チップで、前モデルv2比で消費電力40%削減・推論速度2.1倍を実現した。主要顧客は自動車メーカーA社とロボットメーカーB社。2024年4月に出荷開始。",
    "ZetaGuardは量子暗号通信ミドルウェアで、2024年10月にβ版をリリースした。金融機関向けに2025年度の本格展開を予定している。PoC段階の顧客は3社（メガバンク2行、証券1社）。",
    "ZetaSenseは産業用IoTセンサープラットフォームで、2023年度に販売終了した旧製品である。後継はZetaCore v3のIoTエディション。",

    # --- 人事・組織 ---
    "エグザンプルデータパブリッシャーのCTOは田中美咲氏（2021年にGoogleから転職）。VP of Engineeringは李明浩氏（2023年にAmazonから転職）。AI研究部門の部長は鈴木拓也氏。",
    "エグザンプルデータパブリッシャーの有給休暇取得率は2024年度で87.3%。育児休業取得率は男性72%・女性100%。離職率は2023年度8.2%→2024年度5.1%に改善した。",
    "エグザンプルデータパブリッシャーの新卒採用人数は2024年度が85名（うちエンジニア63名）、2025年度計画は110名（うちエンジニア80名）。中途採用は2024年度が204名。",

    # --- 研究開発戦略 ---
    "エグザンプルデータパブリッシャーの中期経営計画（2024-2026年）では、重点投資分野としてエッジAI（投資額60億円）、量子暗号通信（投資額30億円）、生成AI応用（投資額20億円）の3領域を掲げている。",
    "エグザンプルデータパブリッシャーのAI研究部門は2024年度にNeurIPS 2本、ICML 1本の論文が採択された。特にエッジデバイス向け量子化手法の研究が高く評価されている。",

    # --- パートナーシップ・イベント ---
    "エグザンプルデータパブリッシャーは2024年8月にドイツのシュミットAG社と資本業務提携を締結した。シュミットAG社は欧州最大の産業用ロボットメーカーで、ZetaCore v3の欧州販売をシュミットAG社が担う。",
    "エグザンプルデータパブリッシャーは毎年11月に技術カンファレンス「ZetaConf」を開催している。2024年のZetaConf 2024には参加者2,300名が集まり、基調講演はCTO田中美咲氏が担当した。",

    # --- 知財・セキュリティ ---
    "エグザンプルデータパブリッシャーの特許保有数は2024年度末時点で国内287件、海外142件の計429件。2024年度の新規出願は国内52件、海外31件であった。",
    "エグザンプルデータパブリッシャーのISO 27001認証は2023年6月に取得。SOC 2 Type II報告書は2024年3月に初取得した。セキュリティ専任チームは12名体制。",
]

# ---------------------------------------------------------------------------
# 2. Embedding
# ---------------------------------------------------------------------------
embedding_model = SentenceTransformer('stsb-xlm-r-multilingual')
doc_embeddings = embedding_model.encode(documents, normalize_embeddings=True)

# ---------------------------------------------------------------------------
# 3. Indexing
# ---------------------------------------------------------------------------
dimension = doc_embeddings.shape[1]
index = faiss.IndexFlatIP(dimension)
index.add(doc_embeddings.astype(np.float32))

print(f"[Indexing] {len(documents)} documents indexed (dim={dimension})")

# ---------------------------------------------------------------------------
# 4. Retrieval
# ---------------------------------------------------------------------------
def retrieve(query, top_k=2):
    query_embedding = embedding_model.encode([query], normalize_embeddings=True)
    scores, indices = index.search(query_embedding.astype(np.float32), top_k)
    
    results = []
    for idx, (i, score) in enumerate(zip(indices[0], scores[0])):
        results.append({
            "rank": idx + 1,
            "doc_id": int(i),
            "score": float(score),
            "content": documents[i],
        })
    return results

# ---------------------------------------------------------------------------
# 5. Generation
# ---------------------------------------------------------------------------
client = genai.Client()

def answer_question(question, use_rag=True):
    if use_rag:
        # Retrieval
        results = retrieve(question, top_k=2)
        
        print(f"\n  [Retrieval Results]")
        for r in results:
            print(f"    #{r['rank']} (score={r['score']:.4f}) {r['content'][:50]}...")
        
        context = "\n".join(r["content"] for r in results)
        prompt = (
            f"以下の参考情報のみに基づいて、質問に正確に回答してください。\n"
            f"参考情報に含まれない内容は「情報がありません」と答えてください。\n\n"
            f"参考情報:\n{context}\n\n"
            f"質問: {question}\n答え:"
        )
    else:
        prompt = f"質問: {question}\n答え:"
    
    response = client.models.generate_content(
        model="gemini-3-flash-preview",
        contents=prompt,
    )
    return response.text

# ---------------------------------------------------------------------------
# 6. Execution
# ---------------------------------------------------------------------------
questions = [
    # 単純な検索（1チャンクで回答可能）
    "エグザンプルデータパブリッシャーのCTOは誰で、どこから転職してきましたか？",

    # 比較・計算（複数チャンクの横断が必要）
    "エグザンプルデータパブリッシャーの売上高は2023年度から2024年度でどれだけ成長しましたか？営業利益率の変化も教えてください。",

    # マルチホップ推論（製品 → パートナー → 戦略の連鎖）
    "ZetaCore v3の欧州展開はどのような体制で行われますか？また、この製品の技術的な強みは何ですか？",

    # 複数領域の統合（人事 + 財務 + 組織の横断）
    "エグザンプルデータパブリッシャーの従業員数の推移と、一人当たり売上高を2023年度・2024年度で比較してください。",

    # 深い推論（中期計画 + 財務 + 製品ロードマップの統合）
    "エグザンプルデータパブリッシャーの中期経営計画における投資配分と、各分野の現在の製品・成果を対応づけて説明してください。",
]

for q in questions:
    print(f"\n{'='*60}")
    print(f"Q: {q}")
    
    print(f"\n  --- RAG あり ---")
    answer_rag = answer_question(q, use_rag=True)
    print(f"  A: {answer_rag}")
    
    print(f"\n  --- RAG なし ---")
    answer_no_rag = answer_question(q, use_rag=False)
    print(f"  A: {answer_no_rag}")
